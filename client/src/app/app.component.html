<div class="app-container" dir="rtl">
  <h1>🚀 יועץ פיננסי חכם</h1>

  <!-- <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <h5>🔍 מידע דיבוג:</h5>
    <p>כמות שיחות: {{ conversations?.length || 0 }}</p>
    <p>טוען: {{ loading }}</p>
    <p>שיחה נוכחית: {{ currentSessionId }}</p>
    
    הצגת השיחה הראשונה לדיבוג 
    <div *ngIf="conversations && conversations.length > 0">
      <h6>📋 השיחה הראשונה:</h6>
      <pre>{{ conversations[0] | json }}</pre>
    </div>
    
    <div *ngIf="!conversations || conversations.length === 0">
      <p style="color: red;">❌ אין שיחות להצגה</p>
    </div>
  </div> -->

  <div *ngIf="loading" class="loading">טוען שיחות...</div>

  <!-- <div class="conversations-list" *ngIf="conversations && conversations.length > 0">
    <div *ngFor="let conv of conversations" class="conversation-item" (click)="loadConversation(conv.sessionId)"
      [class.active]="currentSessionId === conv.sessionId">

      <div class="conversation-main">
        <div class="conversation-header">
          <div class="title-section">
            <span class="category-icon">{{getCategoryIcon(conv.category)}}</span>
            <h4 class="conversation-title" [title]="conv.title">{{conv.title}}</h4>
            <span *ngIf="conv.isFavorite" class="favorite-star">⭐</span>
          </div>
          <div class="conversation-meta">
            <span class="message-count">{{conv.messageCount}} הודעות</span>
            <span class="last-activity">{{formatTimeAgo(conv.lastActivity)}}</span>
          </div>
        </div>

        <div class="conversation-description" *ngIf="conv.description" [title]="conv.description">
          {{conv.description}}
        </div>

        <div class="conversation-tags" *ngIf="conv.tags && conv.tags.length > 0">
          <span *ngFor="let tag of conv.tags" class="tag">{{tag}}</span>
        </div>

        <div class="conversation-performance" *ngIf="conv.performance">
          <div class="perf-item" *ngIf="conv.performance.mathFormulas > 0">
            <span class="perf-icon">🧮</span>
            <span>{{conv.performance.mathFormulas}} נוסחאות</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.charts > 0">
            <span class="perf-icon">📊</span>
            <span>{{conv.performance.charts}} גרפים</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.tables > 0">
            <span class="perf-icon">📋</span>
            <span>{{conv.performance.tables}} טבלאות</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.responseTime">
            <span class="perf-icon">⚡</span>
            <span>{{conv.performance.responseTime}}ms</span>
          </div>
        </div>

        <div class="conversation-dates">
          <span class="created-date">נוצר: {{formatDate(conv.createdAt)}}</span>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Action Buttons -->
  <div class="action-buttons">
    <!-- 🆕 New Conversation Management Buttons -->
    <button class="action-btn help-btn" (click)="toggleHelpModal()">
      🚀 מדריך למתחיל
    </button>

    <button class="action-btn conversation-btn" (click)="openConversationDialog()" style="background: #9c27b0;">
      💾 ניהול שיחות
    </button>

    <button class="action-btn save-btn" (click)="saveConversationManually()" style="background: #4caf50;">
      💾 שמור שיחה
    </button>

    <button class="action-btn new-conversation-btn" (click)="startNewConversation()" style="background: #00bcd4;">
      🆕 שיחה חדשה
    </button>

    <button class="action-btn delete-conversation-btn" (click)="clearConversation()">
      🗑️ מחק שיחה נוכחית
    </button>

    <!-- <button class="action-btn" (click)="exportConversation()">
      💾 יצוא JSON
    </button> -->
    <!-- <button class="action-btn" (click)="downloadPDF()">
      📄 יצוא PDF
    </button> -->
    <button class="action-btn" (click)="downloadHTML()">
      💾 שמור HTML
    </button>
    <!-- Scroll to Bottom Button -->
    <button class="scroll-to-bottom" (click)="scrollToBottom()" *ngIf="conversation.length > 3">
      ⬇️
    </button>
    <!-- <button class="action-btn" (click)="getServerPerformanceStats()" style="background: #2196f3;">
      📊 סטטיסטיקות שרת
    </button> -->
    <!--<button class="action-btn" (click)="testLatexRendering()">
      🧮 בדיקת LaTeX
    </button>
    <button class="action-btn" (click)="checkMathJaxStatus()">
      ⚙️ סטטוס MathJax
    </button>
    <button class="action-btn" (click)="debugLatexContent()">
      🔍 דיבוג תוכן
    </button>
    <button class="action-btn" (click)="reloadMathJax()">
      🔄 טען MathJax מחדש
    </button>-->
    <!-- <button class="action-btn" (click)="forceRenderMathJax()" style="background: #ff6b6b;">
      🚨 כפה רנדור
    </button> -->
    <!-- <button class="action-btn" (click)="debugTableStyling()" style="background: #ff9800;">
      📊 דיבוג טבלאות
    </button> -->
    <!-- <button class="action-btn" (click)="forceTableStyling()" style="background: #9c27b0;">
      🎨 כפה עיצוב טבלאות
    </button> -->
  </div>

  <!-- Quick Messages -->
  <div class="quick-messages">
    <button *ngFor="let quickMsg of getQuickMessages()" class="quick-message-btn" (click)="addQuickMessage(quickMsg)">
      {{ quickMsg }}
    </button>
  </div>
  <div class="chat-wrapper">
    <div class="chat-box" #chatBox>
      <div *ngFor="let msg of conversation; let i = index" class="message" [ngClass]="msg.sender"
        [style.animation-delay]="(i * 0.1) + 's'">

        <div *ngIf="msg.sender === 'user'" class="user-message-content">
          {{ msg.message }}
          <div class="message-timestamp">
            {{ getMessageTime(msg.timestamp) }}
          </div>

          <!-- כפתורי עריכה ומחיקה - רק להודעה האחרונה -->
          <div *ngIf="isLastUserMessage(msg.id) && canEditOrDeleteLastMessage()" class="message-actions">
            <button class="action-icon-btn edit-btn" (click)="editLastUserMessage()" title="ערוך הודעה">
              ✏️
            </button>
            <button class="action-icon-btn delete-btn" (click)="deleteLastUserMessage()" title="מחק הודעה">
              🗑️
            </button>
          </div>
        </div>

        <!-- מצב עריכה -->
        <div *ngIf="isEditingLastMessage && editingMessageId === msg.id" class="user-message-edit">
          <div class="edit-container">
            <textarea [(ngModel)]="editingMessageText" (keydown)="onEditKeydown($event)" (input)="autoGrowEdit($event)"
              class="edit-message-textarea" placeholder="ערוך את ההודעה שלך..." rows="3">
              </textarea>

            <div class="edit-actions">
              <button class="edit-action-btn save-btn" (click)="saveEditedMessage()"
                [disabled]="!editingMessageText.trim()">
                💾 שמור ושלח מחדש
              </button>
              <button class="edit-action-btn cancel-btn" (click)="cancelEditMessage()">
                ❌ ביטול
              </button>
            </div>

            <div class="edit-help">
              💡 Enter = שמור | Shift+Enter = שורה חדשה | Esc = ביטול
            </div>
          </div>
        </div>


        <div *ngIf="msg.sender === 'ai'" class="ai-message-content">
          <!-- תגיות מומחים -->
          <div *ngIf="msg.agentsUsed && msg.agentsUsed.length > 0" class="agent-badges-row">
            <span class="agent-badge" *ngFor="let agent of msg.agentsUsed"
                  [attr.data-agent]="agent.agent_id">
              {{ agent.agent_icon }} {{ agent.agent_name }}
            </span>
            <span *ngIf="msg.mode === 'multi'" class="agent-badge agent-badge--synthesis">
              🔗 ניתוח משולב
            </span>
          </div>
          <div [innerHTML]="msg.message"></div>
          <div class="message-timestamp">
            {{ getMessageTime(msg.timestamp) }}
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div *ngIf="isTyping && !loading" class="typing-indicator">
        <span style="color: #64b5f6;">💭 אתה כותב...</span>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span class="loading-text">מתייעץ עם המומחים...</span>
      </div>

      
    </div>
  </div>

  <div class="input-box">
    <textarea [(ngModel)]="userInput" placeholder="💭 כתוב כאן את השאלה הפיננסית שלך..."
      (keydown.control.enter)="sendMessage()" (keydown.meta.enter)="sendMessage()" (keydown.escape)="userInput = ''"
      (input)="autoGrow($event); onTyping()" rows="1" style="overflow:hidden; resize:none;" maxlength="1000"
      #messageInput>
    </textarea>

    <button (click)="sendMessage()" [disabled]="loading || !userInput.trim()" class="send-button">
      <span *ngIf="!loading">📤 שלח</span>
      <span *ngIf="loading">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </span>
    </button>
  </div>

  <div class="input-footer">
    <span class="char-counter" [class.warning]="userInput.length > 800">
      {{ userInput.length }}/1000
    </span>
    <span class="tip">💡 Enter=שלח | Shift+Enter=שורה חדשה | Ctrl+Enter=שלח מהיר</span>
  </div>

  <!-- 🆕 Conversation Dialog Component -->
  <app-conversation-dialog [isOpen]="showConversationDialog" (conversationSelected)="onConversationSelected($event)"
    (closeEvent)="closeConversationDialog()">
  </app-conversation-dialog>

  <!-- ====================================================
       🚀 HELP MODAL — דף הסבר מרשים
       ==================================================== -->
  <div class="help-overlay" *ngIf="showHelpModal" (click)="toggleHelpModal()">
    <div class="help-modal" (click)="$event.stopPropagation()">

      <!-- CLOSE -->
      <button class="help-close" (click)="toggleHelpModal()">✕</button>

      <!-- ── HEADER ── -->
      <div class="help-header">
        <div class="help-header-glow"></div>
        <div class="help-logo">🚀</div>
        <h2 class="help-title">יועץ פיננסי חכם</h2>
        <p class="help-subtitle">
          מערכת בינה מלאכותית מולטי-סוכן — שישה מומחים פיננסיים עובדים <em>במקביל</em> כדי לתת לך את התשובה הטובה ביותר
        </p>
        <div class="help-badges">
          <span class="hbadge">⚡ GPT-4o</span>
          <span class="hbadge">📊 גרפים חיים</span>
          <span class="hbadge">🧮 נוסחאות מתמטיות</span>
          <span class="hbadge">💾 שמירת שיחות</span>
        </div>
      </div>

      <!-- ── HOW IT WORKS ── -->
      <div class="help-section">
        <h3 class="help-section-title">⚙️ איך המערכת עובדת?</h3>
        <div class="help-flow">
          <div class="flow-step">
            <div class="flow-icon">💬</div>
            <div class="flow-label">אתה שואל</div>
            <div class="flow-desc">שאלה חופשית בעברית</div>
          </div>
          <div class="flow-arrow">→</div>
          <div class="flow-step">
            <div class="flow-icon">🧠</div>
            <div class="flow-label">הניתוב החכם</div>
            <div class="flow-desc">AI מזהה אילו מומחים רלוונטיים</div>
          </div>
          <div class="flow-arrow">→</div>
          <div class="flow-step">
            <div class="flow-icon">⚡</div>
            <div class="flow-label">מומחים במקביל</div>
            <div class="flow-desc">עד 3 מומחים עונים בו-זמנית</div>
          </div>
          <div class="flow-arrow">→</div>
          <div class="flow-step">
            <div class="flow-icon">🔗</div>
            <div class="flow-label">סינתזה</div>
            <div class="flow-desc">תשובה מאוחדת + תובנות חדשות</div>
          </div>
        </div>
      </div>

      <!-- ── AGENTS GRID ── -->
      <div class="help-section">
        <h3 class="help-section-title">👥 המומחים שלך</h3>
        <div class="agents-grid">

          <div class="agent-card" data-agent="pension">
            <div class="agent-card-icon">🏦</div>
            <div class="agent-card-name">מומחה פנסיה</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('כמה אחוז מהמשכורת כדאי להפריש לפנסיה?')">כמה לחסוך לפנסיה?</li>
              <li (click)="sendFromHelp('מה ההבדל בין קרן פנסיה לביטוח מנהלים?')">קרן פנסיה vs ביטוח מנהלים</li>
              <li (click)="sendFromHelp('מה יהיה גובה הפנסיה שלי אם אני מרוויח 15,000 ש&quot;ח?')">חישוב קצבת פרישה</li>
            </ul>
          </div>

          <div class="agent-card" data-agent="mortgage">
            <div class="agent-card-icon">🏠</div>
            <div class="agent-card-name">מומחה משכנתא</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('כמה הון עצמי צריך לרכישת דירה ב-2 מיליון?')">הון עצמי לדירה</li>
              <li (click)="sendFromHelp('מה עדיף — מסלול פריים או קל&quot;צ במשכנתא?')">מסלולי משכנתא</li>
              <li (click)="sendFromHelp('האם כדאי לי לקנות דירה או להישאר בשכירות?')">קנייה מול שכירות</li>
            </ul>
          </div>

          <div class="agent-card" data-agent="investment">
            <div class="agent-card-icon">📈</div>
            <div class="agent-card-name">מומחה השקעות</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('איך לבנות תיק השקעות מפוזר עם 100,000 ש&quot;ח?')">בניית תיק השקעות</li>
              <li (click)="sendFromHelp('מה ההבדל בין ETF לקרן נאמנות?')">ETF vs קרן נאמנות</li>
              <li (click)="sendFromHelp('כמה כסף יהיה לי אחרי 20 שנה אם אחסוך 2,000 ש&quot;ח בחודש?')">ריבית דריבית לאורך זמן</li>
            </ul>
          </div>

          <div class="agent-card" data-agent="tax">
            <div class="agent-card-icon">🧾</div>
            <div class="agent-card-name">מומחה מיסוי</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('כמה מס הכנסה אשלם על משכורת של 20,000 ש&quot;ח?')">חישוב מס הכנסה</li>
              <li (click)="sendFromHelp('איך אקבל החזר מס מקסימלי בישראל?')">מקסום החזר מס</li>
              <li (click)="sendFromHelp('מהו מס שבח ואיך לחשב אותו על מכירת דירה?')">מס שבח על דירה</li>
            </ul>
          </div>

          <div class="agent-card" data-agent="budget">
            <div class="agent-card-icon">📊</div>
            <div class="agent-card-name">מומחה תקציב</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('תעזור לי לבנות תקציב חודשי למשפחה עם הכנסה של 20,000 ש&quot;ח')">תקציב משפחתי</li>
              <li (click)="sendFromHelp('איך לצאת מחובות בצורה מהירה ויעילה?')">תכנית יציאה מחובות</li>
              <li (click)="sendFromHelp('כמה כסף צריך בקרן חירום ואיך לבנות אותה?')">בניית קרן חירום</li>
            </ul>
          </div>

          <div class="agent-card" data-agent="general">
            <div class="agent-card-icon">💼</div>
            <div class="agent-card-name">יועץ כללי</div>
            <ul class="agent-card-examples">
              <li (click)="sendFromHelp('מה הצעדים הפיננסיים שצריך לעשות בגיל 30?')">מפת דרכים פיננסית</li>
              <li (click)="sendFromHelp('מה ההבדל בין אינפלציה לריבית ואיך זה משפיע עלי?')">מושגים פיננסיים בסיסיים</li>
              <li (click)="sendFromHelp('תסביר לי את כלל 50-30-20 לניהול כספים')">כלל 50-30-20</li>
            </ul>
          </div>

        </div>
      </div>

      <!-- ── POWER TIPS ── -->
      <div class="help-section">
        <h3 class="help-section-title">💡 שאלות שמפעילות מספר מומחים יחד</h3>
        <div class="power-tips">
          <div class="tip-card" (click)="sendFromHelp('אני בן 35, מרוויח 18,000 ש&quot;ח, יש לי חיסכון של 200,000 ש&quot;ח. רוצה לקנות דירה תוך 5 שנים ולפרוש בגיל 65. מה הדרך הטובה ביותר?')">
            <span class="tip-icon">🔥</span>
            <span class="tip-text">תכנון פיננסי מקיף — פנסיה + משכנתא + השקעות</span>
            <span class="tip-agents">🏦 + 🏠 + 📈</span>
          </div>
          <div class="tip-card" (click)="sendFromHelp('מכרתי דירה ב-2.5 מיליון ש&quot;ח. איך לנהל את הכסף הזה — מה המיסים שאשלם, איפה להשקיע, ואיך זה ישפיע על הפנסיה שלי?')">
            <span class="tip-icon">💰</span>
            <span class="tip-text">ניהול כסף ממכירת דירה — מס + השקעות + פנסיה</span>
            <span class="tip-agents">🧾 + 📈 + 🏦</span>
          </div>
          <div class="tip-card" (click)="sendFromHelp('אני עצמאי עם הכנסה לא יציבה של 10,000-25,000 ש&quot;ח. איך לנהל תקציב, מה לשלם בביטוח לאומי, ואיך לחסוך לפנסיה?')">
            <span class="tip-icon">⚡</span>
            <span class="tip-text">פיננסים לעצמאי — תקציב + מס + פנסיה</span>
            <span class="tip-agents">📊 + 🧾 + 🏦</span>
          </div>
          <div class="tip-card" (click)="sendFromHelp('הבנק מציע לי משכנתא בריבית 5.2%. כמה שלם בסך הכל? האם כדאי לי מחזור? מה ההשפעה על ההשקעות שלי?')">
            <span class="tip-icon">🎯</span>
            <span class="tip-text">ניתוח משכנתא ומיחזור — השוואה + מחשבון + השקעות</span>
            <span class="tip-agents">🏠 + 📈 + 💼</span>
          </div>
        </div>
      </div>

      <!-- ── CAPABILITIES ── -->
      <div class="help-section">
        <h3 class="help-section-title">✨ יכולות ייחודיות</h3>
        <div class="capabilities-grid">
          <div class="cap-card">
            <span class="cap-icon">🧮</span>
            <span class="cap-title">נוסחאות מתמטיות</span>
            <span class="cap-desc">חישובי ריבית דריבית, לוחות סילוקין, NPV ועוד — מוצגים בצורה ויזואלית</span>
          </div>
          <div class="cap-card">
            <span class="cap-icon">📊</span>
            <span class="cap-title">גרפים אינטראקטיביים</span>
            <span class="cap-desc">גרפי קו, עמודות ועוגה שנוצרים בזמן אמת להמחשת הנתונים שלך</span>
          </div>
          <div class="cap-card">
            <span class="cap-icon">📋</span>
            <span class="cap-title">טבלאות השוואה</span>
            <span class="cap-desc">השוואות מפורטות בין אפשרויות — מסלולי משכנתא, תיקי השקעות ועוד</span>
          </div>
          <div class="cap-card">
            <span class="cap-icon">💾</span>
            <span class="cap-title">היסטוריית שיחות</span>
            <span class="cap-desc">שמירה אוטומטית של כל שיחה עם חיפוש, תיוג וסינון לפי נושא</span>
          </div>
        </div>
      </div>

      <!-- ── CTA ── -->
      <div class="help-cta">
        <p class="help-cta-text">מוכן להתחיל? בחר שאלה מלמעלה או כתוב שלך</p>
        <button class="help-cta-btn" (click)="sendFromHelp('שלום! ספר לי מה אתה יכול לעשות בשבילי')">
          🚀 התחל עכשיו — דוגמה מהירה
        </button>
        <button class="help-close-link" (click)="toggleHelpModal()">סגור ועבור לצ\'אט</button>
      </div>

    </div>
  </div>

</div>
<div class="app-container" dir="rtl">
  <h1>ğŸš€ ×™×•×¢×¥ ×¤×™× × ×¡×™ ×—×›×</h1>

  <!-- <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <h5>ğŸ” ××™×“×¢ ×“×™×‘×•×’:</h5>
    <p>×›××•×ª ×©×™×—×•×ª: {{ conversations?.length || 0 }}</p>
    <p>×˜×•×¢×Ÿ: {{ loading }}</p>
    <p>×©×™×—×” × ×•×›×—×™×ª: {{ currentSessionId }}</p>
    
    ×”×¦×’×ª ×”×©×™×—×” ×”×¨××©×•× ×” ×œ×“×™×‘×•×’ 
    <div *ngIf="conversations && conversations.length > 0">
      <h6>ğŸ“‹ ×”×©×™×—×” ×”×¨××©×•× ×”:</h6>
      <pre>{{ conversations[0] | json }}</pre>
    </div>
    
    <div *ngIf="!conversations || conversations.length === 0">
      <p style="color: red;">âŒ ××™×Ÿ ×©×™×—×•×ª ×œ×”×¦×’×”</p>
    </div>
  </div> -->

  <div *ngIf="loading" class="loading">×˜×•×¢×Ÿ ×©×™×—×•×ª...</div>

  <!-- <div class="conversations-list" *ngIf="conversations && conversations.length > 0">
    <div *ngFor="let conv of conversations" class="conversation-item" (click)="loadConversation(conv.sessionId)"
      [class.active]="currentSessionId === conv.sessionId">

      <div class="conversation-main">
        <div class="conversation-header">
          <div class="title-section">
            <span class="category-icon">{{getCategoryIcon(conv.category)}}</span>
            <h4 class="conversation-title" [title]="conv.title">{{conv.title}}</h4>
            <span *ngIf="conv.isFavorite" class="favorite-star">â­</span>
          </div>
          <div class="conversation-meta">
            <span class="message-count">{{conv.messageCount}} ×”×•×“×¢×•×ª</span>
            <span class="last-activity">{{formatTimeAgo(conv.lastActivity)}}</span>
          </div>
        </div>

        <div class="conversation-description" *ngIf="conv.description" [title]="conv.description">
          {{conv.description}}
        </div>

        <div class="conversation-tags" *ngIf="conv.tags && conv.tags.length > 0">
          <span *ngFor="let tag of conv.tags" class="tag">{{tag}}</span>
        </div>

        <div class="conversation-performance" *ngIf="conv.performance">
          <div class="perf-item" *ngIf="conv.performance.mathFormulas > 0">
            <span class="perf-icon">ğŸ§®</span>
            <span>{{conv.performance.mathFormulas}} × ×•×¡×—××•×ª</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.charts > 0">
            <span class="perf-icon">ğŸ“Š</span>
            <span>{{conv.performance.charts}} ×’×¨×¤×™×</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.tables > 0">
            <span class="perf-icon">ğŸ“‹</span>
            <span>{{conv.performance.tables}} ×˜×‘×œ××•×ª</span>
          </div>
          <div class="perf-item" *ngIf="conv.performance.responseTime">
            <span class="perf-icon">âš¡</span>
            <span>{{conv.performance.responseTime}}ms</span>
          </div>
        </div>

        <div class="conversation-dates">
          <span class="created-date">× ×•×¦×¨: {{formatDate(conv.createdAt)}}</span>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Action Buttons -->
  <div class="action-buttons">
    <!-- ğŸ†• New Conversation Management Buttons -->
    <button class="action-btn conversation-btn" (click)="openConversationDialog()" style="background: #9c27b0;">
      ğŸ’¾ × ×™×”×•×œ ×©×™×—×•×ª
    </button>

    <button class="action-btn save-btn" (click)="saveConversationManually()" style="background: #4caf50;">
      ğŸ’¾ ×©××•×¨ ×©×™×—×”
    </button>

    <button class="action-btn new-conversation-btn" (click)="startNewConversation()" style="background: #00bcd4;">
      ğŸ†• ×©×™×—×” ×—×“×©×”
    </button>

    <button class="action-btn delete-conversation-btn" (click)="clearConversation()">
      ğŸ—‘ï¸ ××—×§ ×©×™×—×” × ×•×›×—×™×ª
    </button>

    <!-- <button class="action-btn" (click)="exportConversation()">
      ğŸ’¾ ×™×¦×•× JSON
    </button> -->
    <!-- <button class="action-btn" (click)="downloadPDF()">
      ğŸ“„ ×™×¦×•× PDF
    </button> -->
    <button class="action-btn" (click)="downloadHTML()">
      ğŸ’¾ ×©××•×¨ HTML
    </button>
    <!-- Scroll to Bottom Button -->
    <button class="scroll-to-bottom" (click)="scrollToBottom()" *ngIf="conversation.length > 3">
      â¬‡ï¸
    </button>
    <!-- <button class="action-btn" (click)="getServerPerformanceStats()" style="background: #2196f3;">
      ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×¨×ª
    </button> -->
    <!--<button class="action-btn" (click)="testLatexRendering()">
      ğŸ§® ×‘×“×™×§×ª LaTeX
    </button>
    <button class="action-btn" (click)="checkMathJaxStatus()">
      âš™ï¸ ×¡×˜×˜×•×¡ MathJax
    </button>
    <button class="action-btn" (click)="debugLatexContent()">
      ğŸ” ×“×™×‘×•×’ ×ª×•×›×Ÿ
    </button>
    <button class="action-btn" (click)="reloadMathJax()">
      ğŸ”„ ×˜×¢×Ÿ MathJax ××—×“×©
    </button>-->
    <!-- <button class="action-btn" (click)="forceRenderMathJax()" style="background: #ff6b6b;">
      ğŸš¨ ×›×¤×” ×¨× ×“×•×¨
    </button> -->
    <!-- <button class="action-btn" (click)="debugTableStyling()" style="background: #ff9800;">
      ğŸ“Š ×“×™×‘×•×’ ×˜×‘×œ××•×ª
    </button> -->
    <!-- <button class="action-btn" (click)="forceTableStyling()" style="background: #9c27b0;">
      ğŸ¨ ×›×¤×” ×¢×™×¦×•×‘ ×˜×‘×œ××•×ª
    </button> -->
  </div>

  <!-- Quick Messages -->
  <div class="quick-messages">
    <button *ngFor="let quickMsg of getQuickMessages()" class="quick-message-btn" (click)="addQuickMessage(quickMsg)">
      {{ quickMsg }}
    </button>
  </div>
  <div class="chat-wrapper">
    <div class="chat-box" #chatBox>
      <div *ngFor="let msg of conversation; let i = index" class="message" [ngClass]="msg.sender"
        [style.animation-delay]="(i * 0.1) + 's'">

        <div *ngIf="msg.sender === 'user'" class="user-message-content">
          {{ msg.message }}
          <div class="message-timestamp">
            {{ getMessageTime(msg.timestamp) }}
          </div>

          <!-- ×›×¤×ª×•×¨×™ ×¢×¨×™×›×” ×•××—×™×§×” - ×¨×§ ×œ×”×•×“×¢×” ×”××—×¨×•× ×” -->
          <div *ngIf="isLastUserMessage(msg.id) && canEditOrDeleteLastMessage()" class="message-actions">
            <button class="action-icon-btn edit-btn" (click)="editLastUserMessage()" title="×¢×¨×•×š ×”×•×“×¢×”">
              âœï¸
            </button>
            <button class="action-icon-btn delete-btn" (click)="deleteLastUserMessage()" title="××—×§ ×”×•×“×¢×”">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>

        <!-- ××¦×‘ ×¢×¨×™×›×” -->
        <div *ngIf="isEditingLastMessage && editingMessageId === msg.id" class="user-message-edit">
          <div class="edit-container">
            <textarea [(ngModel)]="editingMessageText" (keydown)="onEditKeydown($event)" (input)="autoGrowEdit($event)"
              class="edit-message-textarea" placeholder="×¢×¨×•×š ××ª ×”×”×•×“×¢×” ×©×œ×š..." rows="3">
              </textarea>

            <div class="edit-actions">
              <button class="edit-action-btn save-btn" (click)="saveEditedMessage()"
                [disabled]="!editingMessageText.trim()">
                ğŸ’¾ ×©××•×¨ ×•×©×œ×— ××—×“×©
              </button>
              <button class="edit-action-btn cancel-btn" (click)="cancelEditMessage()">
                âŒ ×‘×™×˜×•×œ
              </button>
            </div>

            <div class="edit-help">
              ğŸ’¡ Enter = ×©××•×¨ | Shift+Enter = ×©×•×¨×” ×—×“×©×” | Esc = ×‘×™×˜×•×œ
            </div>
          </div>
        </div>


        <div *ngIf="msg.sender === 'ai'" class="ai-message-content">
          <div [innerHTML]="msg.message"></div>
          <div class="message-timestamp">
            {{ getMessageTime(msg.timestamp) }}
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div *ngIf="isTyping && !loading" class="typing-indicator">
        <span style="color: #64b5f6;">ğŸ’­ ××ª×” ×›×•×ª×‘...</span>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        ××—×©×‘ ×ª×©×•×‘×” ×—×›××”...
      </div>

      
    </div>
  </div>

  <div class="input-box">
    <textarea [(ngModel)]="userInput" placeholder="ğŸ’­ ×›×ª×•×‘ ×›××Ÿ ××ª ×”×©××œ×” ×”×¤×™× × ×¡×™×ª ×©×œ×š..."
      (keydown.control.enter)="sendMessage()" (keydown.meta.enter)="sendMessage()" (keydown.escape)="userInput = ''"
      (input)="autoGrow($event); onTyping()" rows="1" style="overflow:hidden; resize:none;" maxlength="1000"
      #messageInput>
    </textarea>

    <button (click)="sendMessage()" [disabled]="loading || !userInput.trim()" class="send-button">
      <span *ngIf="!loading">ğŸ“¤ ×©×œ×—</span>
      <span *ngIf="loading">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </span>
    </button>
  </div>

  <div class="input-footer">
    <span class="char-counter" [class.warning]="userInput.length > 800">
      {{ userInput.length }}/1000
    </span>
    <span class="tip">ğŸ’¡ Enter=×©×œ×— | Shift+Enter=×©×•×¨×” ×—×“×©×” | Ctrl+Enter=×©×œ×— ××”×™×¨</span>
  </div>

  <!-- ğŸ†• Conversation Dialog Component -->
  <app-conversation-dialog [isOpen]="showConversationDialog" (conversationSelected)="onConversationSelected($event)"
    (closeEvent)="closeConversationDialog()">
  </app-conversation-dialog>
</div>